<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Dodger 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        /* Custom CSS for Game Aesthetics */
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #0d0d1a; /* Deep space background */
            font-family: 'Inter', sans-serif;
            color: #fff;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 1000px;
            max-height: 800px;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(70, 150, 255, 0.5);
            overflow: hidden;
            background: radial-gradient(circle at center, #1a1a33 0%, #0d0d1a 100%);
        }
        canvas {
            display: block;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        #start-screen, #game-over-screen {
            text-align: center;
            padding: 30px;
            background: rgba(40, 40, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(100, 200, 255, 0.5);
            transform: scale(1);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.03); }
        }

        h1 {
            font-size: 2.5rem;
            color: #5eff5e;
            text-shadow: 0 0 10px rgba(94, 255, 94, 0.8);
            margin-bottom: 10px;
        }
        p {
            font-size: 1.1rem;
            color: #ccc;
            margin: 5px 0;
        }
        button {
            padding: 12px 25px;
            font-size: 1.2rem;
            margin-top: 20px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
            letter-spacing: 1px;
        }
        button:hover {
            background: linear-gradient(45deg, #0072ff, #00c6ff);
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6);
            transform: translateY(-2px);
        }

        #score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 8px rgba(255, 204, 0, 0.6);
            z-index: 50;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="score-display">Score: 0</div>

    <!-- Start Screen -->
    <div id="overlay" class="active">
        <div id="start-screen">
            <h1>üöÄ Cosmic Dodger 3D ü™ê</h1>
            <p>Dodge the asteroids and survive!</p>
            <p>Controls: Use **Left** and **Right** arrow keys (or A/D) to move.</p>
            <p>Objective: Stay alive as long as possible!</p>
            <button onclick="startGame()">Start Game</button>
        </div>

        <!-- Game Over Screen (Hidden initially) -->
        <div id="game-over-screen" style="display: none;">
            <h1>GAME OVER!</h1>
            <p id="final-score">Your Score: 0</p>
            <button onclick="restartGame()">Play Again</button>
        </div>
    </div>
    <!-- The canvas will be appended here by Three.js -->
</div>

<script>
    // --- Global Configuration ---
    let game = {
        state: 'ready', // 'ready', 'playing', 'over'
        score: 0,
        highScore: 0,
        asteroidSpeed: 0.1,
        asteroidInterval: 1000,
        lastSpawnTime: 0,
        playerSpeed: 0.2
    };

    // --- Three.js Setup ---
    let scene, camera, renderer;
    let player, keyState = {};
    const asteroids = [];
    const CAMERA_Z = 10;
    const CAMERA_Y = 5;
    const GAME_WIDTH = 10;
    const PLAYER_SPEED_LIMIT = 5;

    // --- Tone.js Audio Setup ---
    let droneSynth, noiseSynth;
    const Tone = window.Tone; // Get Tone.js from window object

    function initAudio() {
        if (!Tone.context || game.state !== 'ready') return;

        // 1. Background Drone (Ambient Space Music)
        droneSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "square" },
            envelope: {
                attack: 2,
                decay: 0.5,
                sustain: 0.1,
                release: 5
            },
            volume: -15
        }).toDestination();

        // 2. Explosion Sound (Game Over)
        noiseSynth = new Tone.NoiseSynth({
            noise: { type: "pink" },
            envelope: {
                attack: 0.005,
                decay: 0.2,
                sustain: 0.05,
                release: 1
            },
            volume: 0
        }).toDestination();
    }

    function playDroneMusic() {
        if (!droneSynth) return;
        // Simple ambient chord progression (C minor)
        droneSynth.triggerAttackRelease(["C3", "Eb3", "G3", "Bb3"], "8n", Tone.now());
        droneSynth.triggerAttackRelease(["C3", "D3", "F3", "A3"], "8n", Tone.now() + 1); // F minor/diminished feel
        droneSynth.triggerAttackRelease(["G2", "Bb2", "D3", "F3"], "8n", Tone.now() + 2); // G minor feel
        // Loop the pattern
        Tone.Transport.scheduleRepeat(() => {
            playDroneMusic();
        }, "3s");
        Tone.Transport.start();
    }

    function stopDroneMusic() {
        if (droneSynth) {
            Tone.Transport.stop();
            droneSynth.releaseAll();
        }
    }

    function playExplosionSound() {
        if (noiseSynth) {
            noiseSynth.triggerAttackRelease("4n");
        }
    }

    // --- Three.js Game Functions ---

    function initThree() {
        // Scene setup
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0d0d1a); // Darker blue/purple

        // Camera setup (Perspective)
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, CAMERA_Y, CAMERA_Z);
        camera.lookAt(0, 0, 0);

        // Renderer setup
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-container').appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 2); // Soft white light
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(0, 10, 10);
        scene.add(directionalLight);

        // Player (Simple blue cone)
        const playerGeometry = new THREE.ConeGeometry(0.5, 1, 32);
        const playerMaterial = new THREE.MeshPhongMaterial({ color: 0x00c6ff, emissive: 0x0072ff, shininess: 100 });
        player = new THREE.Mesh(playerGeometry, playerMaterial);
        player.position.set(0, 0.5, 0); // Start at the center of the XZ plane
        player.rotation.x = -Math.PI / 2; // Point forward
        player.castShadow = true;
        scene.add(player);

        // Ground/Play Area Plane (Cosmic Grid)
        const gridHelper = new THREE.GridHelper(20, 20, 0x4444ff, 0x222244);
        gridHelper.position.y = 0;
        scene.add(gridHelper);

        window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
        // Adjust size to fit the container
        const container = document.getElementById('game-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
    }

    function createAsteroid() {
        const radius = Math.random() * 0.5 + 0.5; // Size between 0.5 and 1.0
        const geometry = new THREE.SphereGeometry(radius, 8, 8); // Low poly sphere for asteroids
        const material = new THREE.MeshPhongMaterial({
            color: new THREE.Color(Math.random() * 0x888888 + 0x555555),
            flatShading: true
        });
        const asteroid = new THREE.Mesh(geometry, material);

        // Spawn far away (negative Z)
        asteroid.position.set(
            (Math.random() * GAME_WIDTH - GAME_WIDTH / 2), // Random X position
            radius, // Sit on the ground plane
            -50 // Start far away
        );

        // Store bounding box data for collision detection
        asteroid.userData = {
            radius: radius
        };

        asteroids.push(asteroid);
        scene.add(asteroid);
    }

    function updateAsteroids() {
        const now = performance.now();
        if (now - game.lastSpawnTime > game.asteroidInterval) {
            createAsteroid();
            game.lastSpawnTime = now;
        }

        for (let i = asteroids.length - 1; i >= 0; i--) {
            const asteroid = asteroids[i];
            // Move asteroid towards the player (positive Z)
            asteroid.position.z += game.asteroidSpeed;
            // Simple rotation for visual effect
            asteroid.rotation.x += 0.01;
            asteroid.rotation.y += 0.01;

            // Check if asteroid is past the player (off-screen)
            if (asteroid.position.z > player.position.z + 5) {
                // Asteroid dodged! Increase score
                scene.remove(asteroid);
                asteroids.splice(i, 1);
                game.score++;
                document.getElementById('score-display').textContent = `Score: ${game.score}`;

                // Gradually increase difficulty
                game.asteroidSpeed += 0.0005;
                game.asteroidInterval = Math.max(500, game.asteroidInterval - 1);
            }
        }
    }

    function checkCollision() {
        const playerBox = new THREE.Box3().setFromObject(player);
        const playerRadius = 0.5; // Approximate player collision sphere radius

        for (const asteroid of asteroids) {
            const distance = player.position.distanceTo(asteroid.position);
            const minDistance = playerRadius + asteroid.userData.radius;

            if (distance < minDistance) {
                // Collision detected!
                gameOver();
                return true;
            }
        }
        return false;
    }

    function handlePlayerMovement() {
        let moveX = 0;
        if (keyState['ArrowLeft'] || keyState['a']) {
            moveX -= 1;
        }
        if (keyState['ArrowRight'] || keyState['d']) {
            moveX += 1;
        }

        if (moveX !== 0) {
            // Calculate new position
            let newX = player.position.x + moveX * game.playerSpeed;

            // Clamp position to the game bounds
            newX = Math.max(-GAME_WIDTH / 2 + 0.5, newX);
            newX = Math.min(GAME_WIDTH / 2 - 0.5, newX);

            player.position.x = newX;
        }
    }

    // --- Core Game Loop ---

    function animate() {
        requestAnimationFrame(animate);

        if (game.state === 'playing') {
            handlePlayerMovement();
            updateAsteroids();
            checkCollision();
        }

        renderer.render(scene, camera);
    }

    // --- Game State Management ---

    function startGame() {
        // Tone.js requires a user interaction to start the audio context
        if (Tone.context.state !== 'running') {
            Tone.start();
        }
        initAudio(); // Initialize audio synths
        playDroneMusic();

        document.getElementById('overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('overlay').style.display = 'none';
        }, 500); // Wait for transition

        game.state = 'playing';
        game.score = 0;
        game.asteroidSpeed = 0.1;
        game.asteroidInterval = 1000;
        document.getElementById('score-display').textContent = `Score: 0`;
        // Clear existing asteroids
        asteroids.forEach(a => scene.remove(a));
        asteroids.length = 0;
        player.position.set(0, 0.5, 0); // Reset player position
        game.lastSpawnTime = performance.now();
    }

    function gameOver() {
        game.state = 'over';
        stopDroneMusic();
        playExplosionSound();

        // Update high score
        if (game.score > game.highScore) {
            game.highScore = game.score;
        }

        // Show Game Over screen
        document.getElementById('final-score').textContent = `Your Score: ${game.score} (High Score: ${game.highScore})`;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'block';
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('overlay').style.opacity = '1';

        // Add visual explosion effect to the player (scale and color change)
        player.material.color.set(0xff0000);
        player.scale.set(1.5, 1.5, 1.5);
    }

    function restartGame() {
        // Reset player visuals
        player.material.color.set(0x00c6ff);
        player.scale.set(1, 1, 1);

        document.getElementById('game-over-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'block';
        startGame();
    }

    // --- Event Listeners ---
    document.addEventListener('keydown', (event) => {
        const key = event.key.toLowerCase();
        if (key === 'arrowleft' || key === 'a' || key === 'arrowright' || key === 'd') {
            keyState[event.key] = true;
            keyState[key] = true;
            event.preventDefault(); // Prevent scrolling
        }
    });

    document.addEventListener('keyup', (event) => {
        const key = event.key.toLowerCase();
        if (key === 'arrowleft' || key === 'a' || key === 'arrowright' || key === 'd') {
            keyState[event.key] = false;
            keyState[key] = false;
            event.preventDefault(); // Prevent scrolling
        }
    });

    // --- Initialization ---
    window.onload = function() {
        initThree();
        // Since the animation loop needs to start immediately to render the starting screen
        // we call animate() here. The game logic inside animate() is gated by game.state === 'playing'.
        animate();
        // Force initial resize call to set canvas size correctly inside the container
        onWindowResize();
    };

</script>

</body>
</html>